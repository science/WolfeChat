<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reasoning Test Runner</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass { background: #1a3a1a; border: 1px solid #0f0; }
        .fail { background: #3a1a1a; border: 1px solid #f00; }
        .info { background: #1a1a3a; border: 1px solid #00f; }
    </style>
</head>
<body>
    <h1>Testing Reasoning Window Fix</h1>
    <div id="results"></div>
    
    <script type="module">
        import { get } from './node_modules/svelte/store/index.mjs';
        import { conversations, chosenConversationId } from './src/stores/stores.js';
        import { reasoningWindows, createReasoningWindow, startReasoningPanel, setReasoningText, completeReasoningPanel, reasoningPanels } from './src/stores/reasoningStore.js';
        
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        async function runTests() {
            log('Starting Reasoning Window Tests...', 'info');
            
            // Test 1: Basic window creation with string ID
            try {
                const testConv = {
                    id: 'test-conv-verify',
                    title: 'Test Conversation',
                    assistantRole: 'You are a helpful assistant.',
                    conversationTokens: 0,
                    history: [{ role: 'user', content: 'Test question' }]
                };
                
                conversations.set([testConv]);
                chosenConversationId.set(0);
                
                const conv = get(conversations)[0];
                const windowId = createReasoningWindow(conv.id, 'gpt-5', 0);
                
                const windows = get(reasoningWindows);
                const createdWindow = windows.find(w => w.id === windowId);
                
                if (createdWindow?.convId === conv.id) {
                    log('✅ Test 1 PASSED: Window correctly uses string conversation ID', 'pass');
                } else {
                    log(`❌ Test 1 FAILED: Expected convId "${conv.id}", got "${createdWindow?.convId}"`, 'fail');
                }
            } catch (e) {
                log(`❌ Test 1 ERROR: ${e.message}`, 'fail');
            }
            
            // Test 2: Panel creation and text update
            try {
                const convId = 'test-conv-verify';
                const windowId = createReasoningWindow(convId, 'gpt-5', 0);
                const panelId = startReasoningPanel('text', convId, windowId);
                
                // Update text using setReasoningText (not appendReasoningText)
                setReasoningText(panelId, 'Test content');
                
                const panels = get(reasoningPanels);
                const panel = panels.find(p => p.id === panelId);
                
                if (panel?.text === 'Test content') {
                    log('✅ Test 2 PASSED: Panel text updated correctly', 'pass');
                } else {
                    log(`❌ Test 2 FAILED: Expected text "Test content", got "${panel?.text}"`, 'fail');
                }
            } catch (e) {
                log(`❌ Test 2 ERROR: ${e.message}`, 'fail');
            }
            
            // Test 3: Multiple text updates (simulating streaming)
            try {
                const convId = 'test-conv-stream';
                const windowId = createReasoningWindow(convId, 'gpt-5', 0);
                const panelId = startReasoningPanel('text', convId, windowId);
                
                // Simulate streaming updates
                setReasoningText(panelId, 'Alpha');
                setReasoningText(panelId, 'AlphaBeta');
                setReasoningText(panelId, 'AlphaBetaGamma');
                completeReasoningPanel(panelId);
                
                const panels = get(reasoningPanels);
                const panel = panels.find(p => p.id === panelId);
                
                if (panel?.text === 'AlphaBetaGamma' && panel?.done === true) {
                    log('✅ Test 3 PASSED: Streaming text updates work correctly', 'pass');
                } else {
                    log(`❌ Test 3 FAILED: Expected "AlphaBetaGamma" and done=true, got "${panel?.text}" and done=${panel?.done}`, 'fail');
                }
            } catch (e) {
                log(`❌ Test 3 ERROR: ${e.message}`, 'fail');
            }
            
            log('Tests completed!', 'info');
        }
        
        runTests();
    </script>
</body>
</html>